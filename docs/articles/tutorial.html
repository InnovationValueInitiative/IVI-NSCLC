<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial • iviNSCLC</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">iviNSCLC</a>
        <span class="label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased package">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">API</a>
</li>
<li>
  <a href="../articles/tutorial.html">Tutorial</a>
</li>
<li>
  <a href="../model-doc/model-doc.pdf">PDF documentation</a>
</li>
<li>
  <a href="../articles/source-data.html">Source data</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/InnovationValueInitiative/IVI-NSCLC">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Tutorial</h1>
            
            <h4 class="date">2019-01-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/InnovationValueInitiative/IVI-NSCLC/blob/master/vignettes/tutorial.Rmd"><code>vignettes/tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>tutorial.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a><span class="header-section-number">1</span> Overview</h1>
<p>The IVI-NSCLC model simulates disease progression for different sequential treatment strategies using a continuous time state transition model (CTSTM) for patients with epidermal growth factor receptor (EGFR) positive NSCLC. Treatment sequences that can be modeled are shown in the figure below. Tyrosine kinase inhibitors (TKIs) can be used at first line. Possible second line treatments (2L) and treatments beyond second line (2L+) depend on whether a patient acquired a T790M mutation.</p>
<p><br><br><img src="treatment-strategies.png" width="800px"><br><br></p>
<p>Sequential treatment can be incorporated into the CTSTM by expanding the number of health states according to the number of treatment lines. In general, one can define a health state for each treatment line, a health state after progression on the final line, and a death state, so a model with n treatment lines will have n+2 health states. A patient with stable disease moves to the second treatment in a sequence after progression on the first treatment, to the third treatment after progression on the second treatment, and so on. A patient can die at any time. Unfortunately, the evidence base is currently too limited to explicitly model the transition rates by line of treatment and a simplified model structure is needed. Two options are available with the IVI-NSCLC model: a four-state model and a three-state model. We prefer the four-state CTSTM because it explicitly models 2L treatments; however, there is no 2L evidence following some 1L treatments (i.e., osimertinib), so a three-state model may be preferred in these cases.</p>
<p>In the four-state model, patients begin 1L treatment in stable disease (S1) and can either transition to the progression state (P1) or death (D). At progression, patients move to the progression-free (stable) state (S2) with 2L treatment and can again either have their disease progress (P3) or die. At P3, patients begin 2L+ treatment and remain in the progressed state until death. Time-varying hazard rates for transitions between states <span class="math inline">\(r\)</span> and <span class="math inline">\(s\)</span> and are denoted by <span class="math inline">\(h^{rs}(u)\)</span>.</p>
<p><br><img src="modstruct4_1L.png" width="800px"><br><br></p>
<p>In the three-state model, all hazard rates are based on 1L clinical trial evidence. Patients begin in stable disease (S1) and they can transition to the progression state (P1) or death (D).</p>
<p><br><img src="modstruct3_1L.png" width="800px"><br><br></p>
<p>The three and four-state model structures are used to construct an economic model that consists of three primary submodels: (i) a disease progression model (i.e., transition model) that determines transitions between health states, (ii) a utility model that simulates the health-state utility of each health state, and (iii) a set of cost models that simulates the costs associated with multiple cost categories (i.e., drug acquisition and administration costs, inpatient medical costs, outpatient medical costs, adverse event costs, and productivity losses). The economic model simulates relevant outcomes of interest including the probabilities of being in each of the health states over time, quality-adjusted life-years (QALYs), and costs by category. Probabilistic sensitivity analysis (PSA) is used to propagate uncertainty in the model input parameters throughout the model.</p>
<p>Two R packages are needed to simulate the model: the <code>iviNSCLC</code> and <a href="https://innovationvalueinitiative.github.io/hesim/">hesim</a> packages. We will also use <a href="https://ggplot2.tidyverse.org/">ggplot2</a>, <a href="https://cran.r-project.org/web/packages/gridExtra/index.html">gridExtra</a>, and <a href="https://scales.r-lib.org/">scales</a> for plotting, <a href="https://rmarkdown.rstudio.com/lesson-7.html">knitr</a> to create tables, and <a href="https://github.com/Rdatatable/data.table/wiki">data.table</a> to manipulate data and simulation output.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"iviNSCLC"</span>)
<span class="kw">library</span>(<span class="st">"hesim"</span>)
<span class="kw">library</span>(<span class="st">"data.table"</span>)
<span class="kw">library</span>(<span class="st">"ggplot2"</span>)
<span class="kw">library</span>(<span class="st">"gridExtra"</span>)
<span class="kw">library</span>(<span class="st">"scales"</span>)
<span class="kw">library</span>(<span class="st">"knitr"</span>)
ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>())</code></pre></div>
</div>
<div id="parameter-estimates" class="section level1">
<h1 class="hasAnchor">
<a href="#parameter-estimates" class="anchor"></a><span class="header-section-number">2</span> Parameter estimates</h1>
<p>A number of different statistical models are used to parameterize the economic model. First, Bayesian network meta-analyses (NMAs) were conducted to parameterize multi-state statistical models for the health-state transitions and the probability of grade 3/4 adverse events. Second, estimates from the literature were used to characterize probability distributions of utility and each cost category. The parameter estimates, which load with the <code>iviNSCLC</code> package, are as follows:</p>
<ul>
<li>
<a href="../reference/params_mstate_nma.html"><code>params_mstate_nma</code></a>: The posterior distribution for the parameters of the Bayesian multi-state NMA.</li>
<li>
<a href="../reference/params_ae_nma.html"><code>params_ae_nma</code></a>: The posterior distribution for the parameters of the Bayesian NMA of adverse events. Estimated using a binomial model with a logit link.</li>
<li>
<a href="../reference/params_utility.html"><code>params_utility</code></a>: The probability distribution of the health state utility associated with each health state (S1, P1, and P2).</li>
<li>
<a href="../reference/params_costs_tx.html"><code>params_costs_tx</code></a>: The drug acquisition and administration costs for each treatment.</li>
<li>
<a href="../reference/params_costs_inpt.html"><code>params_costs_inpt</code></a>: Inpatient medical costs by health state (S1, P1, and P2).</li>
<li>
<a href="../reference/params_costs_op.html"><code>params_costs_op</code></a>: Outpatient medical costs by health state (S1, P1, and P2).</li>
<li>
<a href="../reference/params_costs_ae.html"><code>params_costs_ae</code></a>: The costs associated with each of the adverse events from the NMA.</li>
<li>
<a href="../reference/params_costs_prod.html"><code>params_costs_prod</code></a>: Productivity costs including costs from temporary disability, permanent disability, and premature mortality.</li>
</ul>
</div>
<div id="economic-model" class="section level1">
<h1 class="hasAnchor">
<a href="#economic-model" class="anchor"></a><span class="header-section-number">3</span> Economic model</h1>
<p>We provide an example a four-state model for 1L treatment, while also showing how a three-state model could be specified. Importantly, different modeling approaches are used for the three-state and four-state approaches. Since a “clock-forward” multi-state NMA was conducted separately by line of treatment, the four-state model is a mixture of clock-forward and “clock-reset” models. In the clock-reset approach, time <span class="math inline">\(u\)</span> in <span class="math inline">\(h^{rs}(u)\)</span> resets after each transition whereas in the clock-forward approach time <span class="math inline">\(u\)</span> refers to time since the start of the model (see the tutorial <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.2712">here</a> for a more detailed discussion). In the four-state model, the clock resets when entering state S1. Conversely, in the three-state model (either starting at 1L or 2L), the transition rates are always estimated using a NMA of treatments within a single line, so a clock-forward multi-state model must be used.</p>
<p>An individual-level simulation is required to simulate clock-reset and mixtures of clock-forward and clock-reset models, and can also be used to simulate clock-forward models. The individual-level model is simulated in R using the <code>IndivCtstm</code> class from the <a href="https://innovationvalueinitiative.github.io/hesim/">hesim</a> package.</p>
<div id="set-up" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up" class="anchor"></a><span class="header-section-number">3.1</span> Set up</h2>
<div id="patient-population" class="section level3">
<h3 class="hasAnchor">
<a href="#patient-population" class="anchor"></a><span class="header-section-number">3.1.1</span> Patient population</h3>
<p>The first step in the analysis is to define the target population. In the individual-level model, a sufficient number of patients must be simulated so that expected (i.e., mean) outcomes are stable across simulations. In this example, we simulate 1,000 patients.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pats &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_patients.html">create_patients</a></span>(<span class="dt">n =</span> <span class="dv">1000</span>)</code></pre></div>
</div>
<div id="treatment-sequences" class="section level3">
<h3 class="hasAnchor">
<a href="#treatment-sequences" class="anchor"></a><span class="header-section-number">3.1.2</span> Treatment sequences</h3>
<p>Since T790M mutation status is unknown in the 1L four-state case, a treatment sequence consists of a 1L treatment and treatment options for both the T790M+ and T790M- cases at 2L and 2L+. Multiple treatment sequences are combined into a “txseq_list” object using <code><a href="../reference/txseq_list.html">txseq_list()</a></code>. We specify that the model begins at first line treatment with the argument <code>start_line = "first"</code> at which time the T790M mutation status is unknown; however, note that the evidence base is currently too limited to reliably simulate disease progression when starting at second line.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">txseq1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txseq.html">txseq</a></span>(<span class="dt">first =</span> <span class="st">"gefitinib"</span>,
                <span class="dt">second =</span> <span class="kw">c</span>(<span class="st">"osimertinib"</span>, <span class="st">"PBDC"</span>),
                <span class="dt">second_plus =</span> <span class="kw">c</span>(<span class="st">"PBDC + bevacizumab"</span>, <span class="st">"PBDC + bevacizumab"</span>))
txseq2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txseq.html">txseq</a></span>(<span class="dt">first =</span> <span class="st">"erlotinib"</span>,
                <span class="dt">second =</span> <span class="kw">c</span>(<span class="st">"osimertinib"</span>, <span class="st">"PBDC"</span>),
                <span class="dt">second_plus =</span> <span class="kw">c</span>(<span class="st">"PBDC + bevacizumab"</span>, <span class="st">"PBDC + bevacizumab"</span>))
txseqs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txseq_list.html">txseq_list</a></span>(<span class="st">"Sequence 1"</span> =<span class="st"> </span>txseq1, <span class="st">"Sequence 2"</span> =<span class="st"> </span>txseq2,
                     <span class="dt">start_line =</span> <span class="st">"first"</span>,
                     <span class="dt">mutation =</span> <span class="st">"unknown"</span>)</code></pre></div>
<p>It is also useful to write a short convenience function for creating informative names for treatment strategies (i.e., treatment sequences), which can be used for plotting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Convenience function to add factor names to data table</span>
<span class="co"># for plotting</span>
strategy_factor &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">rev =</span> <span class="ot">FALSE</span>){ 
  strategy_names &lt;-<span class="st"> </span><span class="kw">names</span>(txseqs)
  <span class="cf">if</span> (rev <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>){
    x[, strategy_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(strategy_id, <span class="dt">levels =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(txseqs), 
                               <span class="dt">labels =</span> strategy_names)]
  } <span class="cf">else</span>{
    x[, strategy_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(strategy_id, <span class="dt">levels =</span> <span class="kw">rev</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(txseqs)), 
                                 <span class="dt">labels =</span> <span class="kw">rev</span>(strategy_names))]
  }
}</code></pre></div>
</div>
<div id="model-structure" class="section level3">
<h3 class="hasAnchor">
<a href="#model-structure" class="anchor"></a><span class="header-section-number">3.1.3</span> Model structure</h3>
<p>A model structure is specified with <code><a href="../reference/model_structure.html">model_structure()</a></code>. The survival distribution used to estimate the multi-state NMA and model transitions between health states is specified using the <code>dist</code> argument. A description of the relevant health states can be generated using <code><a href="../reference/create_states.html">create_states()</a></code> and possible health state transitions are stored in a transition matrix generated using <code><a href="../reference/create_trans_mat.html">create_trans_mat()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">struct &lt;-<span class="st"> </span><span class="kw"><a href="../reference/model_structure.html">model_structure</a></span>(txseqs, <span class="dt">dist =</span> <span class="st">"weibull"</span>, <span class="dt">n_states =</span> <span class="st">"four"</span>)

<span class="co"># Health states</span>
states &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_states.html">create_states</a></span>(struct)
<span class="kw">print</span>(states)</code></pre></div>
<pre><code>##    state_id state_name                       state_name_long
## 1:        1         S1                        Stable with 1L
## 2:        2      P1/S2 Progression with 1L -&gt; Stable with 2L
## 3:        3         P2                   Progression with 2L
## 4:        4          D                                 Death</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Transition matrix</span>
tmat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_trans_mat.html">create_trans_mat</a></span>(struct)
<span class="kw">print</span>(tmat)</code></pre></div>
<pre><code>##       S1 P1/S2 P2  D
## S1    NA     1 NA  2
## P1/S2 NA    NA  3  4
## P2    NA    NA NA  5
## D     NA    NA NA NA</code></pre>
<p>We could have also specified a three-state model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">struct_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/model_structure.html">model_structure</a></span>(txseqs, <span class="dt">dist =</span> <span class="st">"weibull"</span>,
                            <span class="dt">n_states =</span> <span class="st">"three"</span>)
<span class="kw">print</span>(<span class="kw"><a href="../reference/create_states.html">create_states</a></span>(struct_<span class="dv">3</span>))</code></pre></div>
<pre><code>##    state_id state_name     state_name_long
## 1:        1         S1      Stable with 1L
## 2:        2      P1/S2 Progression with 1L
## 3:        3          D               Death</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw"><a href="../reference/create_trans_mat.html">create_trans_mat</a></span>(struct_<span class="dv">3</span>))</code></pre></div>
<pre><code>##       S1 P1/S2  D
## S1    NA     1  2
## P1/S2 NA    NA  3
## D     NA    NA NA</code></pre>
<p>Recall that the transition matrix depends on the model structure.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tmat_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_trans_mat.html">create_trans_mat</a></span>(struct_<span class="dv">3</span>)
<span class="kw">print</span>(tmat_<span class="dv">3</span>)</code></pre></div>
<pre><code>##       S1 P1/S2  D
## S1    NA     1  2
## P1/S2 NA    NA  3
## D     NA    NA NA</code></pre>
<p>As with treatment strategies, its useful to write a convenience function for generating informative names for health states for plotting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">state_factor &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">rev =</span> <span class="ot">FALSE</span>){ 
  state_names &lt;-<span class="st"> </span>states<span class="op">$</span>state_name
  <span class="cf">if</span> (rev <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>){
    x[, state_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(state_id, <span class="dt">levels =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(states), 
                            <span class="dt">labels =</span> state_names)]
  } <span class="cf">else</span>{
    x[, state_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(state_id, <span class="dt">levels =</span> <span class="kw">rev</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(states)), 
                            <span class="dt">labels =</span> <span class="kw">rev</span>(state_names))]
  }  
}</code></pre></div>
</div>
</div>
<div id="constructing-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#constructing-the-model" class="anchor"></a><span class="header-section-number">3.2</span> Constructing the model</h2>
<p>We construct the economic model by combining the separate models for the health state transitions, utility, and costs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n_samples &lt;-<span class="st"> </span><span class="dv">1000</span></code></pre></div>
<div id="health-state-transition-model" class="section level3">
<h3 class="hasAnchor">
<a href="#health-state-transition-model" class="anchor"></a><span class="header-section-number">3.2.1</span> Health state transition model</h3>
<p>Health state transitions are simulated as a function of input data (which contains the covariates from the multi-state model describing differences in transition rates across treatments) and parameters (the coefficients from the multi-state NMA). These are automatically created as a function of the model structure, transition matrix, and patient population with <code><a href="../reference/create_transmod_data.html">create_transmod_data()</a></code> and stored below in a data table named <code>transmod_data</code>. A fraction of patients are T790M mutation positive. Coefficients from the multi-state NMA that are contained in <code>transmod_data</code> are extracted using <code>transmod_params()</code>.</p>
<p>Recall from the discussion above that an individual-level model is required to simulate a CTSTM that that is a mixture of clock-reset and clock-forward approaches. The <code><a href="../reference/create_transmod.html">create_transmod()</a></code> function constructs an individual-level CTSTM (iCTSTM) to model health state transitions (i.e., it returns a <code>hesim</code> object of class <code>IndivCtstmTrans</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Input data</span>
transmod_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_transmod_data.html">create_transmod_data</a></span>(struct, tmat, pats)
## Print first 5 rows and and 10 covariates from data
<span class="kw">print</span>(transmod_data[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]) </code></pre></div>
<pre><code>##    strategy_id patient_id transition_id female      age mutation tx_abb
## 1:           1          1             1      0 84.76998        0    gef
## 2:           1          1             2      0 84.76998        0    gef
## 3:           1          1             3      0 84.76998        0   pbdc
## 4:           1          1             4      0 84.76998        0   pbdc
## 5:           1          1             5      0 84.76998        0   pbdc
##    tx_hist gef_s1p1_a0 gef_s1d_a0
## 1:    &lt;NA&gt;           1          0
## 2:    &lt;NA&gt;           0          1
## 3:     gef           0          0
## 4:     gef           0          0
## 5:     gef           0          0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Parameters</span>
transmod_params &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_transmod_params.html">create_transmod_params</a></span>(<span class="dt">n =</span> n_samples, <span class="dt">data =</span> transmod_data)
## Print first 5 samples from the probability distribution and 4 covariates (which
## match those in 'transmod_data')
transmod_params<span class="op">$</span>coefs<span class="op">$</span>a0[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</code></pre></div>
<pre><code>##      d_erl_s1p1_a0 d_erl_s1d_a0 gef_s1p1_a0 gef_s1d_a0
## [1,]    0.30930473            0   -3.456157 -13.847506
## [2,]   -0.96088614            0   -3.590653 -18.025443
## [3,]    0.45353988            0   -3.770495 -10.985807
## [4,]   -0.04277207            0   -3.799949  -7.074616
## [5,]   -0.83355385            0   -3.687453 -11.838322</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Health state transition model</span>
transmod &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_transmod.html">create_transmod</a></span>(<span class="dt">params =</span> transmod_params, <span class="dt">data =</span> transmod_data)
<span class="kw">class</span>(transmod)</code></pre></div>
<pre><code>## [1] "IndivCtstmTrans" "CtstmTrans"      "R6"</code></pre>
</div>
<div id="adverse-events" class="section level3">
<h3 class="hasAnchor">
<a href="#adverse-events" class="anchor"></a><span class="header-section-number">3.2.2</span> Adverse events</h3>
<p>Adverse events are assumed to occur during the first month of treatment and cause a decrease in utility and an increase in costs. Adverse event probabilities in the model are consequently based on the first treatment in a treatment sequence. We obtain these probabilities from the posterior distributions stored in <code>params_ae_nma</code> using the <code><a href="../reference/ae_probs.html">ae_probs()</a></code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ae_probs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ae_probs.html">ae_probs</a></span>(n_samples, struct)</code></pre></div>
</div>
<div id="utility-and-cost-models" class="section level3">
<h3 class="hasAnchor">
<a href="#utility-and-cost-models" class="anchor"></a><span class="header-section-number">3.2.3</span> Utility and cost models</h3>
<p>We construct a “mean” model for utility. During the first month, utility varies across both treatment strategies and health states because adverse event probabilities vary across treatments; after the first month, utility varies across health states, but it assumed constant across treatments since adverse events no longer occur.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">utilmod &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_utilmod.html">create_utilmod</a></span>(<span class="dt">n =</span> n_samples, <span class="dt">struct =</span> struct, <span class="dt">patients =</span> pats,
                          <span class="dt">ae_probs =</span> ae_probs)</code></pre></div>
<p>We also construct models for each cost category.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">costmods &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_costmods.html">create_costmods</a></span>(<span class="dt">n =</span> n_samples, <span class="dt">struct =</span> struct, <span class="dt">patients =</span> pats, <span class="dt">ae_probs =</span> ae_probs)</code></pre></div>
</div>
<div id="combining-the-models" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-the-models" class="anchor"></a><span class="header-section-number">3.2.4</span> Combining the models</h3>
<p>Now that the transition, utility, and cost models have been constructed, they can be combined to construct the complete economic model. We use the <code>IndivCtstm</code> class from <code>hesim</code>, and instantiate an iCTSTM.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">econmod &lt;-<span class="st"> </span>hesim<span class="op">::</span>IndivCtstm<span class="op">$</span><span class="kw">new</span>(<span class="dt">trans_model =</span> transmod,
                                 <span class="dt">utility_model =</span> utilmod,
                                 <span class="dt">cost_models =</span> costmods)</code></pre></div>
</div>
</div>
<div id="simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation" class="anchor"></a><span class="header-section-number">3.3</span> Simulation</h2>
<div id="disease-progression" class="section level3">
<h3 class="hasAnchor">
<a href="#disease-progression" class="anchor"></a><span class="header-section-number">3.3.1</span> Disease progression</h3>
<p>The iCTSTM is used to simulate disease progression, QALYs, and costs. We begin by simulating disease progression with <code>$sim_disease()</code> and set the time horizon to 20 years. Since the NMA measured time in months, we convert simulated months to years for the economic model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">max_yrs &lt;-<span class="st"> </span><span class="dv">20</span>
max_age &lt;-<span class="st"> </span><span class="dv">100</span>
econmod<span class="op">$</span><span class="kw">sim_disease</span>(<span class="dt">max_t =</span> max_yrs <span class="op">*</span><span class="st"> </span><span class="dv">12</span>, <span class="dt">max_age =</span> max_age <span class="op">*</span><span class="st"> </span><span class="dv">12</span>)
econmod<span class="op">$</span>disprog_[, <span class="st">':='</span> (<span class="dt">time_start =</span> time_start<span class="op">/</span><span class="dv">12</span>, <span class="dt">time_stop =</span> time_stop<span class="op">/</span><span class="dv">12</span>)]</code></pre></div>
<p>We then compute the probability that a patient is in each of the four health states as a function of time and plot mean state probabilities (averaged across the joint probability distribution of the parameters).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">econmod<span class="op">$</span><span class="kw">sim_stateprobs</span>(<span class="dt">t =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">20</span> , <span class="dv">1</span><span class="op">/</span><span class="dv">26</span>)) <span class="co"># Biweekly probabilities</span>

<span class="co"># Plot of state probabilities</span>
stprobs &lt;-<span class="st"> </span>econmod<span class="op">$</span>stateprobs_[, .(<span class="dt">prob_mean =</span> <span class="kw">mean</span>(prob),
                                     <span class="dt">prob_lower =</span> <span class="kw">quantile</span>(prob, .<span class="dv">025</span>),
                                     <span class="dt">prob_upper =</span> <span class="kw">quantile</span>(prob, .<span class="dv">975</span>)),
                                 by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"state_id"</span>, <span class="st">"t"</span>)]
<span class="kw">state_factor</span>(stprobs)
<span class="kw">strategy_factor</span>(stprobs)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(stprobs[t <span class="op">&lt;</span><span class="st"> </span><span class="dv">15</span>], <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> t, <span class="dt">y =</span> prob_mean, <span class="dt">col =</span> strategy_name)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>state_name) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Years"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Probability in health state"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_color_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="tutorial_files/figure-html/stateprobs-1.png" width="672"></p>
<p>Since <a href="https://en.wikipedia.org/wiki/Progression-free_survival">progression-free survival</a> and <a href="https://www.cancer.gov/publications/dictionaries/cancer-terms/def/overall-survival">overall survival</a> are the most commonly reported primary endpoints in clinical trials, they are also useful to compute. We measure PFS as time with stable disease and OS as time before death.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">death_state &lt;-<span class="st"> </span><span class="cf">switch</span>(struct<span class="op">$</span>n_states,
                      <span class="st">"three"</span> =<span class="st"> </span><span class="dv">3</span>,
                      <span class="st">"four"</span> =<span class="st"> </span><span class="dv">4</span>)
curves &lt;-<span class="st"> </span>econmod<span class="op">$</span>stateprobs_[state_id <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>state_id <span class="op">==</span><span class="st"> </span>death_state]
curves[, prob <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(state_id <span class="op">==</span><span class="st"> </span>death_state, <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prob, prob)] <span class="co"># OS is 1 - pr(death)</span>
curves[, lab <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(state_id, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="dv">1</span>, death_state), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"PFS"</span>, <span class="st">"OS"</span>))]
curves &lt;-<span class="st"> </span>curves[, .(<span class="dt">prob_mean =</span> <span class="kw">mean</span>(prob),
                            <span class="dt">prob_lower =</span> <span class="kw">quantile</span>(prob, .<span class="dv">025</span>),
                            <span class="dt">prob_upper =</span> <span class="kw">quantile</span>(prob, .<span class="dv">975</span>)),
                          by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"lab"</span>, <span class="st">"t"</span>)]
<span class="kw">strategy_factor</span>(curves)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(curves[t <span class="op">&lt;</span><span class="st"> </span><span class="dv">15</span>], <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> t, <span class="dt">y =</span> prob_mean, <span class="dt">col =</span> strategy_name)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>lab, <span class="dt">scales =</span> <span class="st">"free_x"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Years"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Survival probability"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_color_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="tutorial_files/figure-html/pfs_os_curves-1.png" width="672"></p>
<p>We can also summarize quantiles of the PFS and OS curves. Here, we plot the median of (mean) PFS and OS.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">quantiles &lt;-<span class="st"> </span>hesim<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/hesim/topics/surv_quantile">surv_quantile</a></span>(curves, <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">025</span>, .<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>, .<span class="dv">975</span>),
                                  <span class="dt">t =</span> <span class="st">"t"</span>,
                                  <span class="dt">surv_cols =</span> <span class="kw">c</span>(<span class="st">"prob_mean"</span>, <span class="st">"prob_lower"</span>, <span class="st">"prob_upper"</span>),
                                  <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"lab"</span>))
<span class="kw">strategy_factor</span>(quantiles, <span class="dt">rev =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(quantiles[prob <span class="op">==</span><span class="st"> </span>.<span class="dv">5</span>], <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> quantile_prob_mean)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>lab, <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">fill =</span> <span class="st">"#d9230f"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">ymin =</span> quantile_prob_lower,
                    <span class="dt">ymax =</span> quantile_prob_upper), <span class="dt">width =</span> .<span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Median years"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>() </code></pre></div>
<p><img src="tutorial_files/figure-html/pfs_os_quantiles-1.png" width="672"></p>
</div>
<div id="adverse-events-1" class="section level3">
<h3 class="hasAnchor">
<a href="#adverse-events-1" class="anchor"></a><span class="header-section-number">3.3.2</span> Adverse events</h3>
<p>The <code><a href="../reference/tidy.ae_probs.html">tidy.ae_probs()</a></code> function can be used to convert an <code>ae_probs</code> object into a tidy <code>data.table</code> suitable for plotting. We do that here to compare adverse event probabilities across treatment strategies.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tidy_ae_probs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tidy.html">tidy</a></span>(ae_probs)
plot_data &lt;-<span class="st"> </span>tidy_ae_probs[, .(<span class="dt">prob_mean =</span> <span class="kw">mean</span>(prob),
                               <span class="dt">prob_lower =</span> <span class="kw">quantile</span>(prob, .<span class="dv">025</span>),
                                <span class="dt">prob_upper =</span> <span class="kw">quantile</span>(prob, .<span class="dv">975</span>)),
                          by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"ae_name"</span>)]
<span class="kw">strategy_factor</span>(plot_data, <span class="dt">rev =</span> <span class="ot">TRUE</span>)
plot_data[, ae_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(ae_name <span class="op">==</span><span class="st"> "Elevated alanine transaminase"</span>,
                              <span class="st">"Elevated </span><span class="ch">\n</span><span class="st"> alanine </span><span class="ch">\n</span><span class="st"> transaminase"</span>,
                              ae_name)]
plot_data[, ae_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(ae_name <span class="op">==</span><span class="st"> "Elevated aspartate transaminase"</span>,
                              <span class="st">"Elevated </span><span class="ch">\n</span><span class="st"> aspartate </span><span class="ch">\n</span><span class="st"> transaminase"</span>,
                              ae_name)]
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(plot_data, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> prob_mean)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span><span class="kw">factor</span>(ae_name), <span class="dt">ncol =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">fill =</span> <span class="st">"#d9230f"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">ymin =</span> prob_lower,
                    <span class="dt">ymax =</span> prob_upper), <span class="dt">width =</span> .<span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">breaks =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/pretty_breaks">pretty_breaks</a></span>(<span class="dt">n =</span> <span class="dv">3</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Probability of adverse event"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">panel.spacing =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="dv">2</span>, <span class="st">"lines"</span>))</code></pre></div>
<p><img src="tutorial_files/figure-html/ae_probs_plot-1.png" width="672"></p>
</div>
<div id="qalys" class="section level3">
<h3 class="hasAnchor">
<a href="#qalys" class="anchor"></a><span class="header-section-number">3.3.3</span> QALYs</h3>
<p>QALYs and life-years can be simulated for each randomly sampled parameter set by treatment strategy and health state. We simulate values without a discount rate and using a 3 percent discount rate and summarize by computing means by treatment strategy and health state.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Simulate</span>
econmod<span class="op">$</span><span class="kw">sim_qalys</span>(<span class="dt">dr =</span> <span class="kw">c</span>(<span class="dv">0</span>, .<span class="dv">03</span>))
mean_qalys &lt;-<span class="st"> </span>econmod<span class="op">$</span>qalys_[, .(<span class="dt">mean_lys =</span> <span class="kw">mean</span>(lys),
                             <span class="dt">mean_qalys =</span> <span class="kw">mean</span>(qalys)),
                             by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"state_id"</span>, <span class="st">"dr"</span>)]</code></pre></div>
<p>We first plot undiscounted life-years by health state.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">state_factor</span>(mean_qalys, <span class="dt">rev =</span> <span class="ot">TRUE</span>)
<span class="kw">strategy_factor</span>(mean_qalys, <span class="dt">rev =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(mean_qalys[dr <span class="op">==</span><span class="st"> </span><span class="dv">0</span>], 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> mean_lys,
                       <span class="dt">fill =</span> state_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Mean life-years"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>() </code></pre></div>
<p><img src="tutorial_files/figure-html/mean_lys-1.png" width="672"></p>
<p>We then plot discounted QALYs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(mean_qalys[dr <span class="op">==</span><span class="st"> </span>.<span class="dv">03</span>],
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> mean_qalys, <span class="dt">fill =</span> state_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Mean QALYs"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>() </code></pre></div>
<p><img src="tutorial_files/figure-html/mean_qalys-1.png" width="672"></p>
</div>
<div id="costs" class="section level3">
<h3 class="hasAnchor">
<a href="#costs" class="anchor"></a><span class="header-section-number">3.3.4</span> Costs</h3>
<div id="health-care-sector-costs" class="section level4">
<h4 class="hasAnchor">
<a href="#health-care-sector-costs" class="anchor"></a><span class="header-section-number">3.3.4.1</span> Health care sector costs</h4>
<p>Mean health care sector costs for each randomly sampled parameter set are simulated by treatment strategy, health state, and category assuming a 3 percent discount rate. Furthermore, now that both costs and QALYs have been simulated, we can summarize clinical benefits and costs (i.e, compute mean costs and QALYs for each treatment strategy by parameter set). Here, we plot mean costs along with 95 percent credible intervals.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Simulate</span>
econmod<span class="op">$</span><span class="kw">sim_costs</span>(<span class="dt">dr =</span> <span class="fl">0.03</span>)
ce_sim &lt;-<span class="st"> </span>econmod<span class="op">$</span><span class="kw">summarize</span>()

<span class="co"># Plot</span>
costs &lt;-<span class="st"> </span>ce_sim<span class="op">$</span>costs[dr <span class="op">==</span><span class="st"> </span>.<span class="dv">03</span> , .(<span class="dt">costs_mean =</span> <span class="kw">mean</span>(costs),
                           <span class="dt">costs_lower =</span> <span class="kw">quantile</span>(costs, .<span class="dv">025</span>),
                           <span class="dt">costs_upper =</span> <span class="kw">quantile</span>(costs, .<span class="dv">975</span>)),
                        by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"category"</span>)]
<span class="kw">strategy_factor</span>(costs)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(costs[category <span class="op">==</span><span class="st"> "total"</span>], 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> costs_mean)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">fill =</span> <span class="st">"#d9230f"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">ymin =</span> costs_lower, 
                    <span class="dt">ymax =</span> costs_upper), <span class="dt">width=</span>.<span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Costs"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/dollar_format">dollar_format</a></span>()) </code></pre></div>
<p><img src="tutorial_files/figure-html/costs-1.png" width="384"></p>
<p>We can also decompose costs by category.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">costs[, category_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(category, 
                                <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">"ae"</span>, <span class="st">"tx_ac"</span>, <span class="st">"tx_admin"</span>, <span class="st">"inpt"</span>, <span class="st">"op"</span>, <span class="st">"total"</span>),
                                <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"Adverse event"</span>, <span class="st">"Drug acquisition"</span>, <span class="st">"Drug administration"</span>,
                                           <span class="st">"Inpatient"</span>, <span class="st">"Outptient"</span>, <span class="st">"Total"</span>))]
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(costs[category <span class="op">!=</span><span class="st"> "total"</span>], 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> costs_mean, <span class="dt">fill =</span> category_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Costs"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/dollar_format">dollar_format</a></span>()) </code></pre></div>
<p><img src="tutorial_files/figure-html/costs_cat-1.png" width="480"></p>
<p>We might also want to examine incremental costs relative to a comparator (say treatment sequence 1).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Compute incremental costs for each possible reference treatment sequence</span>
incr_costs &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">"list"</span>, <span class="dt">length =</span> <span class="kw">length</span>(txseqs))
incr_costs_i &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/copy">copy</a></span>(ce_sim<span class="op">$</span>costs)
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(txseqs)){
  incr_costs_i[, costs_comparator <span class="op">:</span><span class="er">=</span><span class="st"> </span>costs[i], 
                           by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"category"</span>, <span class="st">"dr"</span>, <span class="st">"sample"</span>)]
  incr_costs_i[, icosts <span class="op">:</span><span class="er">=</span><span class="st"> </span>costs <span class="op">-</span><span class="st"> </span>costs_comparator]
  incr_costs[[i]] &lt;-<span class="st"> </span>incr_costs_i[, .(<span class="dt">icosts_mean =</span> <span class="kw">mean</span>(icosts),
                                   <span class="dt">icosts_lower =</span> <span class="kw">quantile</span>(icosts, .<span class="dv">025</span>),
                                   <span class="dt">icosts_upper =</span> <span class="kw">quantile</span>(icosts, .<span class="dv">975</span>)),
                               by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"category"</span>, <span class="st">"dr"</span>, <span class="st">"strategy_id"</span>)]
  <span class="kw">strategy_factor</span>(incr_costs[[i]])
}

<span class="co"># Plot incremental costs with treatment sequence 1 as the reference treatment</span>
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(incr_costs[[<span class="dv">1</span>]][dr <span class="op">==</span><span class="st"> </span>.<span class="dv">03</span> <span class="op">&amp;</span><span class="st"> </span>category <span class="op">==</span><span class="st"> "total"</span> <span class="op">&amp;</span><span class="st"> </span>
<span class="st">                    </span>strategy_id <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>], 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> icosts_mean)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">fill =</span> <span class="st">"#d9230f"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">ymin =</span> icosts_lower, 
                    <span class="dt">ymax =</span> icosts_upper), <span class="dt">width=</span>.<span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span>(<span class="dt">drop =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Incremental costs"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/dollar_format">dollar_format</a></span>())</code></pre></div>
<p><img src="tutorial_files/figure-html/incr_costs-1.png" width="384"></p>
</div>
<div id="productivity-costs" class="section level4">
<h4 class="hasAnchor">
<a href="#productivity-costs" class="anchor"></a><span class="header-section-number">3.3.4.2</span> Productivity costs</h4>
<p>Simulated productivity costs are computed using the <code><a href="../reference/sim_prod_costs.html">sim_prod_costs()</a></code> function. They are currently computed using the human capital approach (HCA) and incorporate productivity losses from premature mortality, temporary leave of absence upon diagnosis, and reduced hours among survivors following a return to work.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prodcosts &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sim_prod_costs.html">sim_prod_costs</a></span>(econmod, <span class="dt">patients =</span> pats)
ce_sim2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/add_prod_costs.html">add_prod_costs</a></span>(ce_sim, <span class="dt">prod_costs =</span> prodcosts)</code></pre></div>
<p>We will replot costs decomposed by category so that we can examine the magnitude of productivity costs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">costs2 &lt;-<span class="st"> </span>ce_sim2<span class="op">$</span>costs[dr <span class="op">==</span><span class="st"> </span>.<span class="dv">03</span> , .(<span class="dt">costs_mean =</span> <span class="kw">mean</span>(costs)),
                        by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"category"</span>)]
<span class="kw">strategy_factor</span>(costs2)
costs2[, category_name <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(category, 
                                <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">"ae"</span>, <span class="st">"tx_ac"</span>, <span class="st">"tx_admin"</span>, <span class="st">"prod"</span>, <span class="st">"inpt"</span>, <span class="st">"op"</span>, <span class="st">"total"</span>),
                                <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"Adverse event"</span>, <span class="st">"Drug acquisition"</span>, <span class="st">"Drug administration"</span>,
                                           <span class="st">"Productivity"</span>, <span class="st">"Inpatient"</span>, <span class="st">"Outptient"</span>, <span class="st">"Total"</span>))]
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(costs2[category <span class="op">!=</span><span class="st"> "total"</span>], 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> costs_mean, <span class="dt">fill =</span> category_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Costs"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/dollar_format">dollar_format</a></span>()) </code></pre></div>
<p><img src="tutorial_files/figure-html/plot_prod_costs_cat-1.png" width="480"></p>
<p>Plots of undecomposed or incremental costs could be recreated in a similar fashion.</p>
</div>
</div>
</div>
</div>
<div id="decision-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#decision-analysis" class="anchor"></a><span class="header-section-number">4</span> Decision analysis</h1>
<p>Decision analysis can be performed using either a cost-effectiveness analysis (CEA) or a multi criteria decision analysis (MCDA) framework.</p>
<div id="cost-effectiveness-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#cost-effectiveness-analysis" class="anchor"></a><span class="header-section-number">4.1</span> Cost-effectiveness analysis</h2>
<p>Before performing the CEA, we will first summarize relevant health and economic outcomes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">outcomes &lt;-<span class="st"> </span><span class="kw"><a href="../reference/summarize_outcomes.html">summarize_outcomes</a></span>(<span class="dt">econmod =</span> econmod, <span class="dt">prod_costs =</span> prodcosts,
                   <span class="dt">dr_qalys =</span> .<span class="dv">03</span>, <span class="dt">dr_costs =</span> .<span class="dv">03</span>, 
                   <span class="dt">strategy_names =</span> <span class="kw">names</span>(txseqs))
knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(outcomes)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">Outcome</th>
<th align="left">Sequence 1</th>
<th align="left">Sequence 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Life-years</td>
<td align="left">3.57 (3.24, 4.05)</td>
<td align="left">4.36 (3.47, 6.68)</td>
</tr>
<tr class="even">
<td align="left">QALYs</td>
<td align="left">2.09 (1.88, 2.36)</td>
<td align="left">2.70 (2.05, 4.49)</td>
</tr>
<tr class="odd">
<td align="left">Drug acquisition costs</td>
<td align="left">220,659 (200,993, 247,352)</td>
<td align="left">290,138 (222,510, 478,780)</td>
</tr>
<tr class="even">
<td align="left">Drug administration costs</td>
<td align="left">12,305 (10,642, 14,949)</td>
<td align="left">11,837 (9,600, 14,518)</td>
</tr>
<tr class="odd">
<td align="left">Outpatient medical costs</td>
<td align="left">43,167 (35,668, 53,858)</td>
<td align="left">42,239 (34,502, 52,329)</td>
</tr>
<tr class="even">
<td align="left">Inpatient medical costs</td>
<td align="left">246,816 (200,287, 308,096)</td>
<td align="left">258,744 (207,719, 327,784)</td>
</tr>
<tr class="odd">
<td align="left">Adverse event costs</td>
<td align="left">4,784 (2,355, 9,120)</td>
<td align="left">7,525 (2,770, 16,218)</td>
</tr>
<tr class="even">
<td align="left">Health care sector costs</td>
<td align="left">527,731 (464,726, 621,062)</td>
<td align="left">610,483 (506,500, 826,907)</td>
</tr>
<tr class="odd">
<td align="left">Productivity costs</td>
<td align="left">58,896 (54,240, 63,198)</td>
<td align="left">53,788 (41,523, 60,606)</td>
</tr>
<tr class="even">
<td align="left">Societal costs</td>
<td align="left">586,627 (524,753, 676,571)</td>
<td align="left">664,271 (565,686, 871,233)</td>
</tr>
<tr class="odd">
<td align="left">Net monetary benefit</td>
<td align="left">-273,844 (-337,980, -225,641)</td>
<td align="left">-259,030 (-330,753, -176,640)</td>
</tr>
</tbody>
</table>
<p>CEA can be <a href="https://innovationvalueinitiative.github.io/hesim/articles/icea.html">performed using <code>hesim</code></a> with the functions <code><a href="http://www.rdocumentation.org/packages/hesim/topics/icea">icea()</a></code> and <code><a href="http://www.rdocumentation.org/packages/hesim/topics/icea">icea_pw()</a></code>. For this analysis, we used the first treatment sequence as the comparator and assume a willingness to pay per QALY of $150,000.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">icea &lt;-<span class="st"> </span>hesim<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/hesim/topics/icea">icea</a></span>(ce_sim, <span class="dt">dr_qalys =</span> .<span class="dv">03</span>, <span class="dt">dr_costs =</span> .<span class="dv">03</span>)
icea_pw &lt;-<span class="st"> </span>hesim<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/hesim/topics/icea">icea_pw</a></span>(ce_sim, <span class="dt">comparator =</span> <span class="dv">1</span>, <span class="dt">dr_qalys =</span> .<span class="dv">03</span>, <span class="dt">dr_costs =</span> .<span class="dv">03</span>)</code></pre></div>
<p>We report <a href="https://en.wikipedia.org/wiki/Incremental_cost-effectiveness_ratio">incremental cost-effective ratios (ICERs)</a>—a commonly used measure for summarizing the cost-effectiveness of interventions—as well as the incremental net monetary benefit (NMB). The incremental NMB is defined as incremental QALYs multiplied by a willingness to pay threshold ($150,000 in this example) less incremental costs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">icer &lt;-<span class="st"> </span>hesim<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/hesim/topics/icer_tbl">icer_tbl</a></span>(icea_pw,
                        <span class="dt">k =</span> <span class="dv">150000</span>, <span class="co"># WTP per QALY </span>
                        <span class="dt">cri =</span> <span class="ot">TRUE</span>,
                        <span class="dt">rownames =</span> <span class="kw">c</span>(<span class="st">"Incremental QALYs"</span>, <span class="st">"Incremental costs ($)"</span>, 
                                     <span class="st">"Incremental NMB ($)"</span>, <span class="st">"ICER ($ per QALY)"</span>, 
                                     <span class="st">"Conclusion"</span>),
                        <span class="dt">colnames =</span> <span class="kw">names</span>(txseqs))
knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(icer)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="left">Sequence 1</th>
<th align="left">Sequence 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Incremental QALYs</td>
<td align="left">-</td>
<td align="left">0.62 (0.02, 2.34)</td>
</tr>
<tr class="even">
<td>Incremental costs ($)</td>
<td align="left">-</td>
<td align="left">82,752 (1,180, 275,265)</td>
</tr>
<tr class="odd">
<td>Incremental NMB ($)</td>
<td align="left">-</td>
<td align="left">9,706 (-19,555, 72,626)</td>
</tr>
<tr class="even">
<td>ICER ($ per QALY)</td>
<td align="left">-</td>
<td align="left">134,253</td>
</tr>
<tr class="odd">
<td>Conclusion</td>
<td align="left">-</td>
<td align="left">Cost-effective</td>
</tr>
</tbody>
</table>
<p>We can also visualize the degree of uncertainty in our simulated cost and QALY values with a cost-effectiveness plane. Simulated points for a given treatment sequence to the right of the dotted line are cost-effective relative to treatment sequence 1 given our willingness to pay threshold of $150,000.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ylim &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(icea_pw<span class="op">$</span>delta[, ic])) <span class="op">*</span><span class="st"> </span><span class="fl">1.1</span>
xlim &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(icea_pw<span class="op">$</span>delta[, ie])) <span class="op">*</span><span class="st"> </span><span class="fl">1.1</span>
<span class="kw">strategy_factor</span>(icea_pw<span class="op">$</span>delta)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(icea_pw<span class="op">$</span>delta, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> ie, <span class="dt">y =</span> ic, <span class="dt">col =</span> strategy_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span>(<span class="dt">size =</span> .<span class="dv">5</span>)  <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Incremental QALYs"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Incremental costs"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> dollar, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span>ylim, ylim)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span>xlim, xlim)) <span class="op">+</span>
<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_colour_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span>(<span class="dt">slope =</span> <span class="dv">150000</span>, <span class="dt">linetype =</span> <span class="st">"dashed"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="dt">xintercept =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="tutorial_files/figure-html/ceplane-1.png" width="672"></p>
<p>A cost-effectiveness acceptability curve (CEAC) is useful way to measure uncertainty in our decision about whether a treatment sequence is cost-effective. We plot the proportion of simulations from the PSA that each treatment sequence is the most cost-effective option (y-axis) against different willingness to pay thresholds (x-axis).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">strategy_factor</span>(icea<span class="op">$</span>mce)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(icea<span class="op">$</span>mce, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> k, <span class="dt">y =</span> prob, <span class="dt">col =</span> strategy_name)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Willingness to pay"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Probability most cost-effective"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">label =</span> scales<span class="op">::</span>dollar) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_colour_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>)</code></pre></div>
<p><img src="tutorial_files/figure-html/ceac-1.png" width="672"></p>
<p>Finally, we can plot the expected value of perfect information (EVPI), which is a measure of the maximum amount that a decision maker would be willing to pay to reduce all uncertainty in all parameters.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(icea<span class="op">$</span>evpi, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> k, <span class="dt">y =</span> evpi)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Willingness to pay"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Expected value of perfect information"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">label =</span> scales<span class="op">::</span>dollar) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> scales<span class="op">::</span>dollar)</code></pre></div>
<p><img src="tutorial_files/figure-html/evpi-1.png" width="672"></p>
</div>
<div id="multi-criteria-decision-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#multi-criteria-decision-analysis" class="anchor"></a><span class="header-section-number">4.2</span> Multi criteria decision analysis</h2>
<p>We perform the MCDA using the approach described by the <a href="https://www.ncbi.nlm.nih.gov/pubmed/26797229">2016 ISPOR Task Force</a>. In this example, the treatment strategies are assessed on eight criteria: life-years with stable disease on 1L treatment, life-years with progressed disease on 1L treatment (or equivalently, life-years stable disease on 2L treatment), life-years with progressed disease on 2L treatment, health care sector costs, productivity costs, route of administration, years since FDA approval, and the probability of experiencing diarrhea. (Note that we restrict adverse events to only diarrhea for illustrative purposes, but that other adverse events could be included as well). Performance for the two treatment attributes—route of administration and years since FDA approval—can be computed with <code><a href="../reference/txattr_performance.html">txattr_performance()</a></code>. Both are a weighted averages of each treatment in a treatment sequence, with weights equal to the proportion of total life years with each treatment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Outcomes by criteria</span>
lys &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(<span class="dt">lys_s1 =</span> econmod<span class="op">$</span>qalys_[state_id <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>dr <span class="op">==</span><span class="st"> </span><span class="fl">0.03</span>, lys],
                  <span class="dt">lys_p1 =</span> econmod<span class="op">$</span>qalys_[state_id <span class="op">==</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>dr <span class="op">==</span><span class="st"> </span><span class="fl">0.03</span>, lys])
<span class="cf">if</span> (struct<span class="op">$</span>n_states <span class="op">==</span><span class="st"> "four"</span>) {
  lys<span class="op">$</span>lys_p2 =<span class="st"> </span>econmod<span class="op">$</span>qalys_[state_id <span class="op">==</span><span class="st"> </span><span class="dv">3</span> <span class="op">&amp;</span><span class="st"> </span>dr <span class="op">==</span><span class="st"> </span><span class="fl">0.03</span>, lys]
}
hc_costs &lt;-<span class="st"> </span>ce_sim<span class="op">$</span>costs[<span class="op">!</span>category <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"prod"</span>, <span class="st">"total"</span>), 
                           .(<span class="dt">costs =</span> <span class="kw">sum</span>(costs)),
                             by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"sample"</span>, <span class="st">"strategy_id"</span>)]
txattr &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txattr_performance.html">txattr_performance</a></span>(<span class="dt">struct =</span> struct, <span class="dt">patients =</span> pats, <span class="dt">econmod =</span> econmod)
outcomes &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(<span class="dt">sample =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>n_samples, <span class="dt">each =</span> <span class="kw">length</span>(txseqs)),
                       <span class="dt">strategy_id =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(txseqs), <span class="dt">times =</span> n_samples),
                       lys,
                       <span class="dt">hc_costs =</span> hc_costs<span class="op">$</span>costs,
                       <span class="dt">prod_costs =</span> prodcosts<span class="op">$</span>costs,
                       <span class="dt">route =</span> txattr<span class="op">$</span>route,
                       <span class="dt">yrs_since_approval =</span> txattr<span class="op">$</span>yrs_since_approval,
                       <span class="dt">diarhhea =</span> <span class="kw">c</span>(<span class="kw">t</span>(ae_probs<span class="op">$</span>diarrhea)))

<span class="co"># Label criteria</span>
lys_vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"lys_s1"</span>, <span class="st">"lys_p1"</span>)
<span class="cf">if</span> (struct<span class="op">$</span>n_states <span class="op">==</span><span class="st"> "four"</span>) {
  lys_vars &lt;-<span class="st"> </span><span class="kw">c</span>(lys_vars, <span class="st">"lys_p2"</span>)
}
lys_names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Life-years stable disease"</span>, <span class="st">"Life-years progressed 1L"</span>)
<span class="cf">if</span> (struct<span class="op">$</span>n_states <span class="op">==</span><span class="st"> "four"</span>){
  lys_names &lt;-<span class="st"> </span><span class="kw">c</span>(lys_names, <span class="st">"Life-years progressed 2L"</span>)
}
criteria_vars &lt;-<span class="st"> </span><span class="kw">c</span>(lys_vars, <span class="st">"hc_costs"</span>, <span class="st">"prod_costs"</span>, <span class="st">"route"</span>, <span class="st">"yrs_since_approval"</span>, <span class="st">"diarhhea"</span>)
criteria_names &lt;-<span class="st"> </span><span class="kw">c</span>(lys_names, 
                    <span class="st">"Health care sector costs"</span>, <span class="st">"Productivity costs"</span>,
                    <span class="st">"Route of administration"</span>, <span class="st">"Years since FDA approval"</span>,
                    <span class="st">"Diarrhea"</span>)</code></pre></div>
<p>Before conducting the MCDA, it useful to summarize the performance of the criteria on their original scales with a “performance matrix”. High values are better for life-years, route of administration (1 = oral, 0 = intravenous), and years since FDA approval while lower values are better for health care sector costs, productivity losses, and the probability of experiencing diarrhea.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">optimal &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">"high"</span>, <span class="kw">length</span>(lys_vars)), <span class="st">"low"</span>, <span class="st">"low"</span>, <span class="st">"high"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>)
performance_mat_orig &lt;-<span class="st"> </span><span class="kw"><a href="../reference/performance_matrix.html">performance_matrix</a></span>(outcomes, 
                                           <span class="dt">strategy =</span> <span class="st">"strategy_id"</span>, 
                                           <span class="dt">criteria =</span> criteria_vars,
                                           <span class="dt">rownames =</span> criteria_names, 
                                           <span class="dt">colnames =</span> <span class="kw">names</span>(txseqs))
knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(performance_mat_orig)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="left">Sequence 1</th>
<th align="left">Sequence 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Life-years stable disease</td>
<td align="left">0.99 (0.90, 1.10)</td>
<td align="left">1.88 (1.03, 4.46)</td>
</tr>
<tr class="even">
<td>Life-years progressed 1L</td>
<td align="left">0.67 (0.59, 0.77)</td>
<td align="left">0.65 (0.54, 0.75)</td>
</tr>
<tr class="odd">
<td>Life-years progressed 2L</td>
<td align="left">1.90 (1.60, 2.38)</td>
<td align="left">1.83 (1.47, 2.29)</td>
</tr>
<tr class="even">
<td>Health care sector costs</td>
<td align="left">527,730 (464,726, 621,062)</td>
<td align="left">610,483 (506,500, 826,907)</td>
</tr>
<tr class="odd">
<td>Productivity costs</td>
<td align="left">58,895 (54,239, 63,198)</td>
<td align="left">53,788 (41,522, 60,606)</td>
</tr>
<tr class="even">
<td>Route of administration</td>
<td align="left">0.41 (0.37, 0.44)</td>
<td align="left">0.49 (0.41, 0.63)</td>
</tr>
<tr class="odd">
<td>Years since FDA approval</td>
<td align="left">8.55 (8.25, 8.89)</td>
<td align="left">12.39 (12.08, 12.80)</td>
</tr>
<tr class="even">
<td>Diarrhea</td>
<td align="left">0.02 (0.01, 0.03)</td>
<td align="left">0.02 (0.00, 0.06)</td>
</tr>
</tbody>
</table>
<p>Next, we conduct the MCDA, which explicitly weights and scores the criteria. Specifically, each criterion is translated onto a common scale ranging from 0 to 100 and a “total value” is computed as a weighted average of each criteria on this common scale. We’ll take a simple approach and use a linear partial value function, which assumes that performance on the original scale can be translated to a common scale in a linear fashion. We illustrate with health care sector costs, where a lower value is better.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plot_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lpvf_plot_data.html">lpvf_plot_data</a></span>(outcomes<span class="op">$</span>hc_costs, <span class="dt">optimal =</span> <span class="st">"low"</span>)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(plot_data, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Health care sector costs"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Score"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">label =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/dollar_format">dollar_format</a></span>()) </code></pre></div>
<p><img src="tutorial_files/figure-html/lpvf-1.png" width="672"></p>
<p>We would ideally estimate weights using preference elicitation techniques such as swing weighting or discrete choice experiments. But since we have not conducted such an analysis, we’ll use example weights for the analysis. We conduct the MCDA with <code><a href="../reference/mcda.html">mcda()</a></code>, which require a probability distribution of model outcomes (from the PSA) for each criteria by treatment strategy. The function translates performance of the criteria to a common scale and computes both a “total value” and the probability that each treatment strategy has a given rank.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">weights &lt;-<span class="st"> </span><span class="kw">c</span>(.<span class="dv">17</span>, .<span class="dv">17</span>, .<span class="dv">16</span>, .<span class="dv">2</span>, .<span class="dv">1</span>, .<span class="dv">05</span>, .<span class="dv">05</span>, .<span class="dv">1</span>)
mcda &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mcda.html">mcda</a></span>(outcomes, <span class="dt">sample =</span> <span class="st">"sample"</span>, <span class="dt">strategy =</span> <span class="st">"strategy_id"</span>,
             <span class="dt">criteria =</span> criteria_vars,
             <span class="dt">weights =</span> weights,
             <span class="dt">optimal =</span> optimal)</code></pre></div>
<p>We can reexamine the performance matrix with criteria now translated to a common scale.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">performance_mat_common &lt;-<span class="st"> </span><span class="kw"><a href="../reference/performance_matrix.html">performance_matrix</a></span>(mcda<span class="op">$</span>scores, 
                                             <span class="dt">strategy =</span> <span class="st">"strategy_id"</span>, 
                                             <span class="dt">criteria =</span> criteria_vars,
                                             <span class="dt">rownames =</span> criteria_names, 
                                             <span class="dt">colnames =</span> <span class="kw">names</span>(txseqs))
knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(performance_mat_common)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="left">Sequence 1</th>
<th align="left">Sequence 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Life-years stable disease</td>
<td align="left">2.32 (1.19, 3.76)</td>
<td align="left">13.76 (2.83, 47.07)</td>
</tr>
<tr class="even">
<td>Life-years progressed 1L</td>
<td align="left">66.72 (51.66, 84.54)</td>
<td align="left">62.27 (42.55, 82.16)</td>
</tr>
<tr class="odd">
<td>Life-years progressed 2L</td>
<td align="left">47.30 (34.12, 68.19)</td>
<td align="left">44.13 (28.52, 64.17)</td>
</tr>
<tr class="even">
<td>Health care sector costs</td>
<td align="left">87.29 (75.43, 95.29)</td>
<td align="left">76.77 (49.28, 89.98)</td>
</tr>
<tr class="odd">
<td>Productivity costs</td>
<td align="left">17.02 (3.92, 31.20)</td>
<td align="left">32.57 (11.81, 69.92)</td>
</tr>
<tr class="even">
<td>Route of administration</td>
<td align="left">13.13 (4.63, 20.99)</td>
<td align="left">32.77 (13.12, 63.41)</td>
</tr>
<tr class="odd">
<td>Years since FDA approval</td>
<td align="left">10.38 (4.62, 16.64)</td>
<td align="left">82.45 (76.63, 90.16)</td>
</tr>
<tr class="even">
<td>Diarrhea</td>
<td align="left">85.02 (71.70, 95.59)</td>
<td align="left">83.88 (46.76, 98.78)</td>
</tr>
</tbody>
</table>
<p>We can also plot the “total value” scores along with 95 percent credible intervals computed using the PSA output.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Total value</span>
total_value &lt;-<span class="st"> </span>mcda<span class="op">$</span>total_value[, .(<span class="dt">mean =</span> <span class="kw">mean</span>(score),
                                    <span class="dt">lower =</span> <span class="kw">quantile</span>(score, .<span class="dv">025</span>),
                                    <span class="dt">upper =</span> <span class="kw">quantile</span>(score, .<span class="dv">975</span>)),
                                by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>)]
<span class="kw">strategy_factor</span>(total_value)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(total_value, 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> mean)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">fill =</span> <span class="st">"#d9230f"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">ymin =</span> lower, 
                    <span class="dt">ymax =</span> upper), <span class="dt">width =</span> .<span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Total value"</span>) </code></pre></div>
<p><img src="tutorial_files/figure-html/mcda-total-value-1.png" width="384"></p>
<p>It can sometimes be useful to decompose these scores by criteria, to help which criteria are most important in driving the results. The contribution of each criteria is the product of the weight and its score on the common scale.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Weighted scores</span>
weighted_scores &lt;-<span class="st"> </span>mcda<span class="op">$</span>weighted_scores[, .(<span class="dt">mean =</span> <span class="kw">mean</span>(weighted_score)),
                                        by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"criteria"</span>)]
weighted_scores[, criteria <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(criteria, 
                                     <span class="dt">levels =</span> criteria_vars,
                                <span class="dt">labels =</span> criteria_names)]
<span class="kw">strategy_factor</span>(weighted_scores)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(weighted_scores, 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> mean, <span class="dt">fill =</span> criteria)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Total value"</span>) </code></pre></div>
<p><img src="tutorial_files/figure-html/mcda-total-value-decompose-1.png" width="480"></p>
<p>The treatment strategies can be ranked by their “total value”, which varies across samples of the PSA. We count the number of times each treatment strategy has a given rank and use this to compute the probability that a treatment strategy has a given ranking. We visualize these results in two equivalent ways: first, with treatment strategies on the x-axis and ranking as a group variable, and second, with rankings on the x-axis and treatment strategy as a group variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prank &lt;-<span class="st"> </span>mcda<span class="op">$</span>prob_rank
<span class="kw">strategy_factor</span>(prank)
prank_levels &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(prank<span class="op">$</span>rank))
prank[, f1_rank <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(rank)]
prank[, f2_rank <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(rank,
                          <span class="dt">levels =</span> prank_levels,
                          <span class="dt">labels =</span> <span class="kw">paste0</span>(<span class="st">"Rank = "</span>, prank_levels))]

<span class="co"># Rank on x-axis</span>
p1 &lt;-<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(prank, 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> f1_rank, <span class="dt">y =</span> prob, <span class="dt">fill =</span> strategy_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Rank"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Probability"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)

<span class="co"># Treatment sequence on x-axis</span>
p2 &lt;-<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(prank, 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> prob, <span class="dt">fill =</span> f2_rank)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Probability"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)

<span class="co"># Combine</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/gridExtra/topics/arrangeGrob">grid.arrange</a></span>(p1, p2, <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="tutorial_files/figure-html/mcda-prob-rank-1.png" width="672"></p>
</div>
</div>
<div id="value-of-hope" class="section level1">
<h1 class="hasAnchor">
<a href="#value-of-hope" class="anchor"></a><span class="header-section-number">5</span> Value of hope</h1>
<p>Standard CEA implicitly ignores preferences over the distribution of survival outcomes because they are based on mean QALYs. There is however some evidence that patients prefer therapies with longer right tails. We refer to these preferences as the “value of hope”, which can be computed using the function <code><a href="../reference/value_of_hope.html">value_of_hope()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">voh &lt;-<span class="st"> </span><span class="kw"><a href="../reference/value_of_hope.html">value_of_hope</a></span>(econmod, <span class="dt">comparator =</span> <span class="dv">1</span>)</code></pre></div>
<p>The certainty equivalent is the number of QALYs that a patient would need to obtain to be indifferent between the comparator and the alternative treatment strategies. The value of hope is the difference between expected incremental QALYs and the certainty equivalent. The plot below compares QALYs computed using “standard” approached based on expected values adjusted according by the value of hope.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plot_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/copy">copy</a></span>(voh)
plot_data[, iqalys_voh <span class="op">:</span><span class="er">=</span><span class="st"> </span>iqalys <span class="op">+</span><span class="st"> </span>voh]
plot_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/melt.data.table">melt</a></span>(plot_data, <span class="dt">id.vars =</span> <span class="kw">c</span>(<span class="st">"strategy_id"</span>),
                  <span class="dt">measure.vars =</span> <span class="kw">c</span>(<span class="st">"iqalys"</span>, <span class="st">"iqalys_voh"</span>),
                  <span class="dt">value.name =</span> <span class="st">"qalys"</span>)
plot_data[, variable <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(variable <span class="op">==</span><span class="st"> "iqalys"</span>, 
                               <span class="st">"Standard"</span>,
                               <span class="st">"With value of hope"</span>)]
<span class="kw">strategy_factor</span>(plot_data)
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(plot_data, 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> qalys, <span class="dt">fill =</span> variable)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Incremental QALYs"</span>)</code></pre></div>
<p><img src="tutorial_files/figure-html/voh-plot-qalys-1.png" width="672"></p>
<p>Since modifications to QALYs also impact estimates of cost-effectiveness, we also compare the incremental NMB (again using a willingness to pay of $150,000) with and without the value of hope.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">k &lt;-<span class="st"> </span><span class="dv">150000</span>
incr_costs_mean &lt;-<span class="st"> </span>incr_costs[[<span class="dv">1</span>]][category <span class="op">==</span><span class="st"> "total"</span> <span class="op">&amp;</span><span class="st"> </span>dr <span class="op">==</span><span class="st"> </span>.<span class="dv">03</span>, 
                                   .(strategy_id, icosts_mean)]
plot_data[, icosts <span class="op">:</span><span class="er">=</span><span class="st"> </span>incr_costs_mean<span class="op">$</span>icosts_mean[<span class="kw">match</span>(strategy_id,
                                            incr_costs_mean<span class="op">$</span>strategy_id)]]
plot_data[, inmb <span class="op">:</span><span class="er">=</span><span class="st"> </span>k <span class="op">*</span><span class="st"> </span>qalys <span class="op">-</span><span class="st"> </span>icosts]
<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(plot_data, 
       <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> strategy_name, <span class="dt">y =</span> inmb, <span class="dt">fill =</span> variable)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_fill_discrete</a></span>(<span class="dt">name =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Incremental NMB"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> scales<span class="op">::</span>dollar)</code></pre></div>
<p><img src="tutorial_files/figure-html/voh-plot-nmb-1.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview"><span class="toc-section-number">1</span> Overview</a></li>
      <li><a href="#parameter-estimates"><span class="toc-section-number">2</span> Parameter estimates</a></li>
      <li>
<a href="#economic-model"><span class="toc-section-number">3</span> Economic model</a><ul class="nav nav-pills nav-stacked">
<li><a href="#set-up"><span class="toc-section-number">3.1</span> Set up</a></li>
      <li><a href="#constructing-the-model"><span class="toc-section-number">3.2</span> Constructing the model</a></li>
      <li><a href="#simulation"><span class="toc-section-number">3.3</span> Simulation</a></li>
      </ul>
</li>
      <li>
<a href="#decision-analysis"><span class="toc-section-number">4</span> Decision analysis</a><ul class="nav nav-pills nav-stacked">
<li><a href="#cost-effectiveness-analysis"><span class="toc-section-number">4.1</span> Cost-effectiveness analysis</a></li>
      <li><a href="#multi-criteria-decision-analysis"><span class="toc-section-number">4.2</span> Multi criteria decision analysis</a></li>
      </ul>
</li>
      <li><a href="#value-of-hope"><span class="toc-section-number">5</span> Value of hope</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Devin Incerti, Jeroen P. Jansen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
